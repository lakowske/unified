# Podman Pod specification for Apache web server
# This file demonstrates poststack's environment management with Jinja2 template processing
apiVersion: v1
kind: Pod
metadata:
  name: unified-apache-{{ POSTSTACK_ENVIRONMENT }}
  labels:
    app: apache
    environment: {{ POSTSTACK_ENVIRONMENT }}
    managed-by: poststack
    project: unified
spec:
{% if APACHE_USE_HOST_NETWORK == "true" %}
  hostNetwork: true
{% endif %}
  initContainers:
  - name: setup-volumes
    image: localhost/unified/apache:latest
    command: ['/bin/bash', '-c']
    args:
    - |
      echo "Setting up Apache volume permissions..."
      mkdir -p /data/logs/apache /etc/apache2/conf.d /data/certificates
      chown -R www-data:certgroup /data/logs/apache
      chmod 755 /data/logs/apache
      chown -R www-data:www-data /etc/apache2/conf.d
      chmod 755 /etc/apache2/conf.d
      chown -R www-data:certgroup /data/certificates
      chmod 755 /data/certificates
      echo "Volume setup complete"
    volumeMounts:
    - name: unified-logs
      mountPath: /data/logs
    - name: apache-config
      mountPath: /etc/apache2/conf.d
    - name: certificates
      mountPath: /data/certificates
  containers:
  - name: apache-web
    image: localhost/unified/apache:latest
{% if APACHE_USE_HOST_NETWORK != "true" %}
    ports:
    - containerPort: 80
      hostPort: {{ APACHE_HOST_PORT | default('8080') }}
      protocol: TCP
    - containerPort: 443
      hostPort: {{ APACHE_HTTPS_PORT | default('8443') }}
      protocol: TCP
{% endif %}
    env:
    # Database connection variables (auto-generated from service discovery)
    - name: DATABASE_URL
      value: "{{ POSTGRES_URL }}"
    - name: ENVIRONMENT
      value: "{{ ENVIRONMENT }}"
    - name: DB_HOST
      value: "{{ POSTGRES_HOST }}"
    - name: DB_PORT
      value: "{{ POSTGRES_PORT }}"
    - name: DB_NAME
      value: "{{ POSTGRES_DATABASE }}"
    - name: DB_USER
      value: "{{ POSTGRES_USER }}"
    - name: DB_PASSWORD
      value: "{{ POSTGRES_PASSWORD }}"
    # Unified project database configuration
    - name: UNIFIED_DB_HOST
      value: "{{ POSTGRES_HOST }}"
    - name: UNIFIED_DB_PORT
      value: "{{ POSTGRES_PORT }}"
    - name: UNIFIED_DB_NAME
      value: "{{ POSTGRES_DATABASE }}"
    - name: UNIFIED_DB_USER
      value: "{{ POSTGRES_USER }}"
    - name: UNIFIED_DB_PASSWORD
      value: "{{ POSTGRES_PASSWORD }}"
    - name: UNIFIED_DB_SCHEMA
      value: "unified"
    # User-defined environment-specific variables
    - name: LOG_LEVEL
      value: "{{ LOG_LEVEL }}"
    - name: DEBUG_MODE
      value: "{{ DEBUG_MODE | default('false') }}"
    - name: CACHE_TTL
      value: "{{ CACHE_TTL | default('300') }}"
    # Apache-specific configuration
    - name: APACHE_SERVER_NAME
      value: "{{ SERVER_NAME | default('localhost') }}"
    - name: APACHE_SERVER_ADMIN
      value: "{{ SERVER_ADMIN | default('admin@localhost') }}"
    - name: APACHE_DOCUMENT_ROOT
      value: "/var/www/unified"
    - name: APACHE_LOG_LEVEL
      value: "{{ APACHE_LOG_LEVEL | default('warn') }}"
    # SSL/TLS Certificate configuration
    - name: SSL_ENABLED
      value: "{{ SSL_ENABLED | default('false') }}"
    - name: SSL_REDIRECT
      value: "{{ SSL_REDIRECT | default('false') }}"
    - name: CERT_TYPE
      value: "{{ CERT_TYPE | default('self-signed') }}"
    # Application-specific configuration
    - name: APP_NAME
      value: "Unified Project"
    - name: APP_VERSION
      value: "{{ APP_VERSION | default('dev') }}"
    volumeMounts:
    - name: unified-logs
      mountPath: /data/logs
    - name: apache-config
      mountPath: /etc/apache2/conf.d
    - name: certificates
      mountPath: /data/certificates
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "500m"
    livenessProbe:
      httpGet:
        path: /health
        port: 80
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /health
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
  volumes:
  - name: unified-logs
    {{ VOLUME_UNIFIED_LOGS_TYPE }}: {{ VOLUME_UNIFIED_LOGS_CONFIG }}
  - name: apache-config
    {{ VOLUME_APACHE_CONFIG_TYPE }}: {{ VOLUME_APACHE_CONFIG_CONFIG }}
  - name: certificates
    {{ VOLUME_CERTIFICATES_TYPE }}: {{ VOLUME_CERTIFICATES_CONFIG }}
  restartPolicy: Always
