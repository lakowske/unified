apiVersion: v1
kind: Pod
metadata:
  name: unified-dns-{{ POSTSTACK_ENVIRONMENT }}-dns-server
  labels:
    app: unified-dns
    environment: {{ POSTSTACK_ENVIRONMENT }}
    component: dns-server
spec:
  {% if NETWORK_MODE == "host" %}
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet
  {% endif %}
  containers:
  - name: dns-server
    image: unified/dns:latest
    ports:
    - containerPort: 53
      protocol: UDP
      name: dns-udp
    - containerPort: 53
      protocol: TCP
      name: dns-tcp
    - containerPort: 953
      protocol: TCP
      name: dns-control
    env:
    - name: DNS_LOG_LEVEL
      value: "{{ DNS_LOG_LEVEL }}"
    - name: DNS_FORWARDERS
      value: "{{ DNS_FORWARDERS }}"
    - name: DNS_ALLOW_QUERY
      value: "{{ DNS_ALLOW_QUERY }}"
    - name: DNS_RECURSION
      value: "{{ DNS_RECURSION }}"
    - name: POSTSTACK_ENVIRONMENT
      value: "{{ POSTSTACK_ENVIRONMENT }}"
    - name: MAIL_DOMAIN
      value: "{{ MAIL_DOMAIN }}"
    - name: MAIL_SERVER_IP
      value: "{{ MAIL_SERVER_IP }}"
    - name: DB_HOST
      value: "{{ DB_HOST }}"
    - name: DB_PORT
      value: "{{ DB_PORT }}"
    - name: DB_NAME
      value: "{{ DB_NAME }}"
    - name: DB_USER
      value: "{{ DB_USER }}"
    - name: DB_PASSWORD
      value: "{{ DB_PASSWORD }}"
    volumeMounts:
    - name: dns-zones
      mountPath: /data/zones
    - name: dns-config
      mountPath: /etc/bind/zones
    - name: dns-logs
      mountPath: /var/log/named
    - name: unified-logs
      mountPath: /data/logs/dns
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"
    livenessProbe:
      exec:
        command:
        - /bin/bash
        - -c
        - "dig @127.0.0.1 -p 53 . NS > /dev/null 2>&1"
      initialDelaySeconds: 30
      periodSeconds: 30
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      exec:
        command:
        - /bin/bash
        - -c
        - "dig @127.0.0.1 -p 53 . NS > /dev/null 2>&1"
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 3
      failureThreshold: 3
    securityContext:
      runAsUser: 101  # bind user
      runAsGroup: 101  # bind group
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        add:
        - NET_BIND_SERVICE
        drop:
        - ALL
  volumes:
  - name: dns-zones
    persistentVolumeClaim:
      claimName: dns-zones-pvc
  - name: dns-config
    emptyDir: {}
  - name: dns-logs
    emptyDir: {}
  - name: unified-logs
    persistentVolumeClaim:
      claimName: unified-logs-pvc
  restartPolicy: Always
