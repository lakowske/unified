# Podman Pod specification for Mail server (Dovecot + Postfix)
# This file demonstrates poststack's environment management with Jinja2 template processing
apiVersion: v1
kind: Pod
metadata:
  name: unified-mail-{{ POSTSTACK_ENVIRONMENT }}
  labels:
    app: mail
    environment: {{ POSTSTACK_ENVIRONMENT }}
    managed-by: poststack
    project: unified
spec:
{% if MAIL_USE_HOST_NETWORK == "true" %}
  hostNetwork: true
{% endif %}
  initContainers:
  - name: setup-volumes
    image: localhost/unified/mail:latest
    command: ['/bin/bash', '-c']
    args:
    - |
      echo "Setting up mail volume permissions..."

      # Create mail directory structure
      mkdir -p /var/mail /data/logs/mail /var/run/dovecot /var/spool/postfix

      # Set proper ownership and permissions
      chown -R vmail:vmail /var/mail
      chown -R vmail:certgroup /data/logs/mail /var/run/dovecot
      chown -R postfix:postfix /var/spool/postfix

      chmod 755 /var/mail /data/logs/mail
      chmod 755 /var/run/dovecot /var/spool/postfix

      echo "Mail volume setup complete"
    volumeMounts:
    - name: mail-data
      mountPath: /var/mail
    - name: unified-logs
      mountPath: /data/logs
    - name: mail-config
      mountPath: /etc/dovecot/conf.d
  containers:
  - name: mail-server
    image: localhost/unified/mail:latest
{% if MAIL_USE_HOST_NETWORK != "true" %}
    ports:
    - containerPort: 25
      hostPort: {{ MAIL_SMTP_PORT | default('2525') }}
      protocol: TCP
    - containerPort: 143
      hostPort: {{ MAIL_IMAP_PORT | default('1144') }}
      protocol: TCP
    - containerPort: 993
      hostPort: {{ MAIL_IMAPS_PORT | default('9933') }}
      protocol: TCP
    - containerPort: 465
      hostPort: {{ MAIL_SMTPS_PORT | default('4465') }}
      protocol: TCP
    - containerPort: 587
      hostPort: {{ MAIL_SUBMISSION_PORT | default('5587') }}
      protocol: TCP
{% endif %}
    env:
    # Database connection variables (auto-generated from service discovery)
    - name: DATABASE_URL
      value: "{{ POSTGRES_URL }}"
    - name: ENVIRONMENT
      value: "{{ ENVIRONMENT }}"
    - name: DB_HOST
      value: "{{ POSTGRES_HOST }}"
    - name: DB_PORT
      value: "{{ POSTGRES_PORT }}"
    - name: DB_NAME
      value: "{{ POSTGRES_DATABASE }}"
    - name: DB_USER
      value: "{{ POSTGRES_USER }}"
    - name: DB_PASSWORD
      value: "{{ POSTGRES_PASSWORD }}"
    - name: DB_SSLMODE
      value: "{{ DB_SSLMODE | default('prefer') }}"
    # User-defined environment-specific variables
    - name: LOG_LEVEL
      value: "{{ LOG_LEVEL }}"
    - name: DEBUG_MODE
      value: "{{ DEBUG_MODE | default('false') }}"
    # Mail-specific configuration
    - name: MAIL_DOMAIN
      value: "{{ MAIL_DOMAIN | default('localhost') }}"
    - name: MAIL_LOG_LEVEL
      value: "{{ MAIL_LOG_LEVEL | default('info') }}"
    - name: VMAIL_UID
      value: "{{ VMAIL_UID | default('5000') }}"
    - name: VMAIL_GID
      value: "{{ VMAIL_GID | default('5000') }}"
    # SSL/TLS Certificate configuration
    - name: SSL_ENABLED
      value: "{{ SSL_ENABLED | default('false') }}"
    - name: CERT_TYPE_PREFERENCE
      value: "{{ CERT_TYPE_PREFERENCE | default('') }}"
    # Application-specific configuration
    - name: APP_NAME
      value: "Unified Mail Server"
    - name: APP_VERSION
      value: "{{ APP_VERSION | default('dev') }}"
    volumeMounts:
    - name: mail-data
      mountPath: /var/mail
    - name: unified-logs
      mountPath: /data/logs
    - name: mail-config
      mountPath: /etc/dovecot/conf.d
    - name: certificates
      mountPath: /data/certificates
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"
    livenessProbe:
      exec:
        command:
        - /usr/local/bin/mail-health-check.sh
      initialDelaySeconds: 60
      periodSeconds: 30
      timeoutSeconds: 10
    readinessProbe:
      exec:
        command:
        - /bin/bash
        - -c
        - "nc -z localhost 25 && nc -z localhost 143"
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
  volumes:
  - name: mail-data
    {{ VOLUME_MAIL_DATA_TYPE }}: {{ VOLUME_MAIL_DATA_CONFIG }}
  - name: unified-logs
    {{ VOLUME_UNIFIED_LOGS_TYPE }}: {{ VOLUME_UNIFIED_LOGS_CONFIG }}
  - name: mail-config
    {{ VOLUME_MAIL_CONFIG_TYPE }}: {{ VOLUME_MAIL_CONFIG_CONFIG }}
  - name: certificates
    {{ VOLUME_CERTIFICATES_TYPE }}: {{ VOLUME_CERTIFICATES_CONFIG }}
  restartPolicy: Always
