# PostgreSQL Pod Deployment Template
# Generated by poststack init command
#
# This file defines how PostgreSQL is deployed in your environment.
# You can customize resource limits, environment variables, and volumes.

apiVersion: v1
kind: Pod
metadata:
  name: unified-postgres-{{ ENVIRONMENT }}
  labels:
    app: postgres
    environment: {{ ENVIRONMENT }}
    managed-by: poststack
    project: unified
    component: database
spec:
  containers:
  - name: postgres
    image: localhost/poststack/postgres:latest
    ports:
    - containerPort: 5432
      hostPort: {{ DB_PORT }}
      protocol: TCP
    env:
    # Database configuration
    - name: POSTGRES_DB
      value: "{{ DB_NAME }}"
    - name: POSTGRES_USER
      value: "{{ DB_USER }}"
    - name: POSTGRES_PASSWORD
      value: "{{ DB_PASSWORD }}"
    - name: POSTGRES_HOST_AUTH_METHOD
      value: "trust"

    # PostgreSQL configuration
    - name: PGDATA
      value: "/data/postgres/data"
    - name: POSTGRES_INITDB_ARGS
      value: "--auth-host=trust --auth-local=peer"

    # Environment info
    - name: ENVIRONMENT
      value: "{{ ENVIRONMENT }}"
    - name: CONFIG_DIR
      value: "/data/config"
    - name: CERT_PATH
      value: "/data/certificates"
    - name: BASE_DIR
      value: "/data"
    - name: LOG_DIR
      value: "/data/logs"

    volumeMounts:
    - name: postgres-data
      mountPath: /data/postgres/data
    - name: unified-logs
      mountPath: /data/logs
    - name: postgres-config
      mountPath: /data/postgres/config

    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "1Gi"
        cpu: "1000m"

    livenessProbe:
      exec:
        command:
        - "/usr/local/bin/postgres-health-check.sh"
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

    readinessProbe:
      exec:
        command:
        - "pg_isready"
        - "-h"
        - "localhost"
        - "-p"
        - "5432"
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3

  volumes:
  - name: postgres-data
    {{ VOLUME_POSTGRES_DATA_TYPE }}: {{ VOLUME_POSTGRES_DATA_CONFIG }}
  - name: unified-logs
    {{ VOLUME_UNIFIED_LOGS_TYPE }}: {{ VOLUME_UNIFIED_LOGS_CONFIG }}
  - name: postgres-config
    {{ VOLUME_POSTGRES_CONFIG_TYPE }}: {{ VOLUME_POSTGRES_CONFIG_CONFIG }}

  restartPolicy: Always

# Configuration Notes:
#
# 1. Environment Variables:
#    Variables like {{ DB_NAME }} are substituted by poststack
#    at deployment time based on your .poststack.yml configuration.
#
# 2. Volumes:
#    Volume configuration is controlled by the 'volumes' section in .poststack.yml.
#    Variables like ${VOLUME_POSTGRES_DATA_TYPE} are generated automatically:
#    - emptyDir: Data is lost when pod restarts (default)
#    - persistentVolumeClaim: Data persists across restarts (named volumes)
#    - hostPath: Data stored on host filesystem
#
#    Example volume configuration in .poststack.yml:
#    volumes:
#      postgres_data:
#        type: named
#        size: "2Gi"
#      postgres_logs:
#        type: named
#        size: "500Mi"
#
# 3. Resource Limits:
#    Adjust memory and CPU limits based on your workload requirements.
#    The defaults should work for development environments.
#
# 4. Health Checks:
#    The liveness probe ensures PostgreSQL is running and responding.
#    The readiness probe ensures the database is ready to accept connections.
#
# 5. Customization:
#    You can modify this file to add additional environment variables,
#    change resource limits, add volumes, or adjust health check settings.
