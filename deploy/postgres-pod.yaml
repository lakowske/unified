# PostgreSQL Pod Deployment Template
# Generated by poststack init command
#
# This file defines how PostgreSQL is deployed in your environment.
# You can customize resource limits, environment variables, and volumes.

apiVersion: v1
kind: Pod
metadata:
  name: postgres-${POSTSTACK_ENVIRONMENT}
  labels:
    app: postgres
    environment: ${POSTSTACK_ENVIRONMENT}
    managed-by: poststack
    component: database
spec:
  containers:
  - name: postgres
    image: localhost/poststack/postgres:latest
    ports:
    - containerPort: 5432
      hostPort: ${POSTSTACK_DB_PORT}
      protocol: TCP
    env:
    # Database configuration from poststack environment
    - name: POSTGRES_DB
      value: "${POSTSTACK_DB_NAME}"
    - name: POSTGRES_USER
      value: "${POSTSTACK_DB_USER}"
    - name: POSTGRES_PASSWORD
      value: "${POSTSTACK_DB_PASSWORD}"
    - name: POSTGRES_HOST_AUTH_METHOD
      value: "trust"

    # PostgreSQL configuration
    - name: PGDATA
      value: "/data/postgres/data"
    - name: POSTGRES_INITDB_ARGS
      value: "--auth-host=trust --auth-local=peer"

    # Poststack environment info
    - name: POSTSTACK_ENVIRONMENT
      value: "${POSTSTACK_ENVIRONMENT}"
    - name: POSTSTACK_CONFIG_DIR
      value: "/data/config"
    - name: POSTSTACK_CERT_PATH
      value: "/data/certificates"
    - name: POSTSTACK_BASE_DIR
      value: "/data"
    - name: POSTSTACK_LOG_DIR
      value: "/data/logs"

    volumeMounts:
    - name: postgres-data
      mountPath: /data/postgres/data
    - name: postgres-logs
      mountPath: /data/postgres/logs
    - name: postgres-config
      mountPath: /data/postgres/config

    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "1Gi"
        cpu: "1000m"

    livenessProbe:
      exec:
        command:
        - "/usr/local/bin/postgres-health-check.sh"
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

    readinessProbe:
      exec:
        command:
        - "pg_isready"
        - "-h"
        - "localhost"
        - "-p"
        - "5432"
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3

  volumes:
  - name: postgres-data
    emptyDir: {}
  - name: postgres-logs
    emptyDir: {}
  - name: postgres-config
    emptyDir: {}

  restartPolicy: Always

# Configuration Notes:
#
# 1. Environment Variables:
#    Variables like ${POSTSTACK_DB_NAME} are substituted by poststack
#    at deployment time based on your .poststack.yml configuration.
#
# 2. Volumes:
#    By default, this uses emptyDir volumes which don't persist data.
#    For production, consider using persistentVolumeClaim volumes.
#
# 3. Resource Limits:
#    Adjust memory and CPU limits based on your workload requirements.
#    The defaults should work for development environments.
#
# 4. Health Checks:
#    The liveness probe ensures PostgreSQL is running and responding.
#    The readiness probe ensures the database is ready to accept connections.
#
# 5. Customization:
#    You can modify this file to add additional environment variables,
#    change resource limits, add volumes, or adjust health check settings.
